{% extends 'base.html' %}
{% import 'components.html' as ui %}
{% set active_page='headers' %}
{% block title %}Email Headers Analysis - DNSTools{% endblock %}
{% block content %}
<div x-data="HeadersPage()" class="space-y-6">
  <div class="panel p-6 rounded-xl space-y-4">
    {{ ui.section_header('fa-file-alt','Email Headers Analysis') }}
    {{ ui.info_banner('fa-info-circle','Email Header Analysis','Paste raw email headers to analyze delivery path, authentication results, and security indicators.') }}

    <div class="mb-6">
      <label class="block text-sm font-semibold text-[#c9d1d9] mb-3"><i class="fas fa-envelope mr-2 text-[#58a6ff]"></i>Paste Email Headers:</label>
      <textarea x-model="headers" x-ref="headersBox" @input="autoGrow && autoGrow($refs.headersBox)" x-init="autoGrow && autoGrow($refs.headersBox)" placeholder="Received: from mail.example.com (mail.example.com [192.0.2.1])
        by mx.recipient.com (Postfix) with ESMTP id 12345
        for <user@recipient.com>; Mon, 1 Jan 2024 12:00:00 +0000
Authentication-Results: mx.recipient.com;
        dkim=pass header.d=example.com;
        spf=pass smtp.mailfrom=example.com;
        dmarc=pass" class="w-full resize-none overflow-hidden min-h-[200px] px-4 py-3 border border-[#30363d] rounded-md focus:outline-none focus:ring-2 focus:ring-[#58a6ff] bg-[#0d1117] text-sm font-mono leading-relaxed text-[#c9d1d9]"></textarea>
      <p class="mt-2 text-xs text-[#8b949e]">Paste the full email headers including Received, Authentication-Results, and other header fields.</p>
    </div>

    <button @click="analyzeHeaders" :disabled="loading || !headers.trim()" class="w-full py-3 px-6 rounded-md font-semibold bg-[#238636] hover:bg-[#2ea043] disabled:bg-[#30363d] text-white transition">
      <span x-show="!loading"><i class="fas fa-search mr-2"></i>Analyze Headers</span>
      <span x-show="loading" style="display: none;"><i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...</span>
    </button>
  </div>

  <div x-show="results" x-transition style="display: none;" class="panel rounded-xl p-6 border border-[#30363d] space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-lg font-semibold text-[#c9d1d9]">Header Analysis Results</h2>
      <button @click="exportResults" class="pill pill-outline pill-green"><i class="fas fa-download"></i><span>Export</span></button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" x-show="results">
      <div class="rounded-lg p-4 border border-[#30363d] bg-[#0d1117]">
        <h4 class="font-semibold mb-2 text-[#c9d1d9]">Authentication Status</h4>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-[#8b949e]">SPF:</span>
            <span class="pill pill-outline" :class="{'pill-green': results?.spf?.status==='pass','pill-red': results?.spf?.status==='fail','pill-orange': results?.spf?.status==='neutral'}" x-text="results?.spf?.status || 'unknown'"></span>
          </div>
          <div x-show="results?.spf?.details" class="text-[10px] text-[#6e7681] ml-2 font-mono" x-text="results?.spf?.details"></div>
          
          <div class="flex justify-between">
            <span class="text-[#8b949e]">DKIM:</span>
            <span class="pill pill-outline" :class="{'pill-green': results?.dkim?.status==='pass','pill-red': results?.dkim?.status==='fail'}" x-text="results?.dkim?.status || 'unknown'"></span>
          </div>
          <div x-show="results?.dkim?.details" class="text-[10px] text-[#6e7681] ml-2 font-mono" x-text="results?.dkim?.details"></div>
          
          <div class="flex justify-between">
            <span class="text-[#8b949e]">DMARC:</span>
            <span class="pill pill-outline" :class="{'pill-green': results?.dmarc?.status==='pass','pill-red': results?.dmarc?.status==='fail'}" x-text="results?.dmarc?.status || 'unknown'"></span>
          </div>
          <div x-show="results?.dmarc?.details" class="text-[10px] text-[#6e7681] ml-2 font-mono" x-text="results?.dmarc?.details"></div>
        </div>
      </div>
      
      <div class="rounded-lg p-4 border border-[#30363d] bg-[#0d1117]">
        <h4 class="font-semibold mb-2 text-[#c9d1d9]">Delivery Path</h4>
        <div class="space-y-1 text-xs">
          <template x-for="hop in results?.delivery_path || []" :key="hop.server">
            <div class="bg-[#161b22] rounded p-2 border border-[#30363d]">
              <div class="font-mono text-[10px] text-[#8b949e]" x-text="hop.server"></div>
              <div class="text-[10px] text-[#6e7681]" x-text="hop.timestamp"></div>
            </div>
          </template>
        </div>
      </div>
      
      <div class="rounded-lg p-4 border border-[#30363d] bg-[#0d1117]">
        <h4 class="font-semibold mb-2 text-[#c9d1d9]">Security Indicators</h4>
        <div class="space-y-2 text-xs">
          <div x-show="results?.security?.tls" class="flex items-center gap-1">
            <i class="fas fa-lock text-[#3fb950]"></i>
            <span class="text-[#8b949e]">TLS Encrypted</span>
          </div>
          <div x-show="!results?.security?.tls && results?.delivery_path?.length > 0" class="flex items-center gap-1">
            <i class="fas fa-unlock text-[#f85149]"></i>
            <span class="text-[#8b949e]">No TLS Encryption</span>
          </div>
          <div x-show="results?.security?.suspicious" class="flex items-center gap-1">
            <i class="fas fa-exclamation-triangle text-[#f85149]"></i>
            <span class="text-[#8b949e]">Security Issues Detected</span>
          </div>
          <div x-show="!results?.security?.suspicious && results?.delivery_path?.length > 0" class="flex items-center gap-1">
            <i class="fas fa-shield-check text-[#3fb950]"></i>
            <span class="text-[#8b949e]">No Security Issues</span>
          </div>
        </div>
        
        <!-- Security Warnings -->
        <div x-show="results?.security?.warnings?.length > 0" class="mt-3">
          <h5 class="font-semibold mb-2 text-[#f85149] text-xs">Security Warnings:</h5>
          <div class="space-y-1">
            <template x-for="warning in results?.security?.warnings || []" :key="warning">
              <div class="bg-[#161b22] rounded p-2 border border-[#f85149] text-[10px] text-[#f85149]">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                <span x-text="warning"></span>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="error && error.length>0" x-transition style="display: none;" class="panel p-4 border border-[#30363d] rounded-xl">
    <p class="text-sm text-[#f85149]" x-text="error"></p>
  </div>
</div>
{% endblock %}